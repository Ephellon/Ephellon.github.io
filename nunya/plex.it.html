<!DOCTYPE html>
<html lang="en" >

<head>
  <meta charset="UTF-8">
  <link rel="shortcut icon" type="image/x-icon" href="https://static.codepen.io/assets/favicon/favicon-8ea04875e70c4b0bb41da869e81236e54394d63638a1ef12fa558a4a835f1164.ico" />
  <link rel="mask-icon" type="" href="https://static.codepen.io/assets/favicon/logo-pin-f2d2b6d2c61838f7e76325261b7195c27224080bc099486ddd6dccb469b8e8e6.svg" color="#111" />
  <title>Plex It!</title>
  <meta charset="utf-8">

  <link href="https://static.plex.tv/assets/plexit/index-75982dc538f700c48148f84ccae5dc001fa18aa2187387e9d2192d15bed45363.css" media="screen" rel="stylesheet" />

  <script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-6111912-22', 'plex.tv');
	ga('send', 'pageview');
  </script>

  <style>
#wtp--plex-it-plugin {
  background: #fff2;
  border-radius: 16px;

  height: 100%;
  width: 100%;
}

#wtp--plex-it-plugin td {
  text-align: center;
}
  </style>
</head>

<body translate="no" >
  <script type="text/template" id="closebutton-template">
  <i class="icon-close"></i>
</script>

<script type="text/template" id="looking-template">
  <h1 class="pull-center">Looking for videos...</h1>
</script>

<script type="text/template" id="empty-template">
</script>

<script type="text/template" id="header-template">
  <div class="thumb-container">
    <img class="thumb">
    <div class="thumb-overlay"></div>
  </div>

  <div class="navbar">
    <button class="queue-btn active" title="Queue"><i class="icon-plus"></i></button><button class="recommend-btn" title="Recommend"><i class="icon-share"></i></button><button class="play-btn" title="Play"><i class="icon-screen"></i></button>
  </div>
</script>

<script type="text/template" id="sunset-template">
  <table id="wtp--plex-it-plugin" ondrop="HANDLE.drop(event)" ondragover="HANDLE.drag(event)"><tbody><tr><td>Drop your items here</td></tr><tbody></table>
</script>

<script>
  var PLEXIT = {
    queueEmail: '',
    token: '', // Will be filled in by a separate request
    myPlexUrl: 'https://plex.tv',
    queueUrl: 'https://plex.tv/queue',
    nodeUrl: 'https://node.plexapp.com:32443/system/services/url/lookup',
    nodeHost: 'https://node.plexapp.com:32443'
  };
</script>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="https://static.plex.tv/assets/jquery-1.9.1-4514122fa0b1addc7cf9b74971cbef98af5e9afed30eef9e4dc36650616447b5.js"><\/script>')</script>
<script src="https://static.plex.tv/assets/plexit-frame/index-ba16c6d6c8cb5d7fc20ccbd8c7bc98f8326ce9a03424368e5e65e89789db7112.js"></script>
<script>
function BookMark(title, href = window.location, image) {
  let urls = load('bookmarks') || [],
      name = title.replace(/[^\w\$\-\+\.\;\(\)]+/g, '');

  save('bookmarks', urls.concat(name));

  return save(name, {
    url: href,
    img: image
  });
}

function load(name) {
  return JSON.parse(localStorage.getItem(btoa(name)));
}

function save(name, data) {
  return localStorage.setItem(btoa(name), JSON.stringify(data));
}

document.body.onload = function() { setTimeout(function() {

    document.querySelectorAll('[type="text/template"]').forEach( e => e.remove() );

    let table = document.body.querySelector('#wtp--plex-it-plugin'),
        array = load('bookmarks');

    if(array && array.length) {
        let strings = [],
            compiled = [],
            object = {},
            width = 8;

        for(let count = 0, length = Math.ceil(array.length / width); count < length; count++)
            for(let index = width * count++, name, url, obj; index < count * width; index++) {
                name = array[index];
                obj = load(name);

                if(name && obj)
                    object[name] = (!/^(null|undefined)?$/.test( url = obj.url || '' ))?
                    `<td id="local-${ name }" local="{:name} ({:url})" name="${ name }" url="${ url.replace(/^(.*?\/\/.*?\/).*$/, '$1') }">
                        <a href="${ url }" target="_blank">
                            <img src="${ obj.img }" />
                            <label>${ name }</label>
                        </a>
                    </td>`: null;
            }

        for(let index = 0, length = array.length, string; index < length; index++)
            if(string = object[array[index]])
                compiled.push(string);

        for(let index = 0, length = compiled.length, string = ''; index <= length; index++) {
            if((index > 0 && index % 3 == 0) || index >= length)
                strings.push(string),
                string = '';
            if(index < length)
                string += compiled[index];
        }

        let html = '';

        strings.map(string =>
            html += `<tr>${ string }</tr>`
        );

        table.innerHTML = `<table><tbody>${ html }</tbody></table>`;
    }

    let messages = {
            "and": "{:{*}}",
            "disabled": "Not yet implemented",
            "is-shy": "Can only be accessed via: {*}",
            "is-slow": "Resource intensive (loads slowly)",
            "local": "Opens a link to ^{*}",
            "pop-ups": "Contains annoying/intrusive ads and/or pop-ups",
            "save-file": "Uses {*} before using your manager(s)",
            // $0.99 one time; $0.99 - $9.99/mon
            "cost-cash-low": "At least {*} (fair)",
            // $9.99 one time; $9.99 - $29.99/mon
            "cost-cash-med": "At least {*} (pricy)",
            // $29.99 one time; $29.99 - $99.99/mon
            "cost-cash-hig": "At least {*} (expensive)"
        },
        parse = (string, attribute, element) => {
            return string
                .replace(/\{\$\}/g, element.title)
                .replace(/\{\*\}/g, element.getAttribute(attribute))
                .replace(/\{\:([\w\- ]+)\}/g, ($0, $1, $$, $_) =>
                    $1.split(' ').map($1 => parse(element.getAttribute($1), $1, element))
                )
                .replace(/\^([a-z])/gi, ($0, $1, $$, $_) => $1.toUpperCase());
        },
        selectors = [];

    for(let key in messages)
        selectors.push(`[${ key }]`);

    let elements = document.querySelectorAll(selectors.join(','));

    for(let element, index = 0, length = elements.length; index < length; index++)
        for(let attribute in messages)
            if(attribute in (element = elements[index]).attributes)
                element.title = `${ parse(messages[attribute], attribute, element) }. ${ element.title }`;
}, 1000)};

let GRAB = (host, pathname = location.pathname.toString(), R = RegExp) => ({
  'amazon': { name: '[data-automation-id="title"], #aiv-content-title, .dv-node-dp-title', year: '[data-automation-id="release-year-badge"], .release-year', img: '.av-bgimg__div, div[style*="sgp-catalog-images"]', alt: [ s => s.replace(/(?:\(.+?\)|(\d+)|\d+\s+seasons?\s+(\d+))\s*$/gi, ''), s => s ] },
  'couchpotato': { name: '[itemprop="description"]', year: '[itemprop="description"] + *', img: 'img[src*="wp-content"]' },
  'fandango': { name: '.subnav__title', year: '.movie-details__release-date', img: '.movie-details__movie-img', zlt: [ s => s.split(/\n+/)[0].trim(), s => s.replace(/.*(\d{4}).*/, '$1').trim() ] },
  'google': { name: 'h1', year: `h1 ~ span${ pathname.startsWith('/store/movies/')? 'first': 'last' }-of-type`, img: 'img[alt="cover art" i]', alt: [ s => s.replace(/\(\s*(\d{4})\s*\).*?$/, ''), s => (R.$1 || s).replace(/^.*(\d+)/, '$1') ] },
  'gostream': { name: '[itemprop="name"]:not(meta)', year: '.mvic-desc [href*="year/"]', img: '.hiddenz' },
  'hulu': { name: '#content [class$="__name"]', year: '#content [class$="__meta"] [class$="segment"]:last-child', img: '', alt: [ s => s, s => s.replace(/.*\((\d{4})\).*/, '$1') ] },
  'imdb': { name: '.originalTitle, .title_wrapper h1', year: '.title_wrapper #titleYear, .title_wrapper [href*="/releaseinfo"]', img: 'img[alt$="poster" i]', alt: [ s => s, s => s.replace(/Series\s+(\d{4}).*?/i, '$1') ], child: true },
  'itunes': { name: '[class*="movie-header__title"], h1[itemprop="name"], h1', year: '[datetime], .release-date > *:last-child', img: '[class*="product"] ~ * picture img', alt: [ s => s.replace(/\s*\((\d+)\)\s*/, ''), s => s.replace(/[^]*(\d{4})[^]*?$/g, '$1') ] },
  'letterboxd': { name: '.headline-1[itemprop="name"]', year: 'small[itemprop="datePublished"]', img: '.image' },
  'metacritic': { name: '.product_page_title > *, .product_title', year: '.product_page_title > .release_year, .product_data .release_data', img: '.summary_img', alt: [ s => s.replace(/\s+/g, ' '), s => s.replace(/\s+/g, ' ') ] },
  'movieo': { name: '#doc_title', year: 'meta[itemprop="datePublished"]', img: 'img.poster' },
  'netflix': { name: '.video-title h4', year: 'null', img: '' },
  'rottentomatoes': { name: '.playButton + .title, [itemprop="name"]', year: '.playButton + .title + *, [itemprop="name"] .subtle', img: '[class*="posterimage" i]', alt: [ s => s.replace(/(.+)\:[^]*$/, /^\/m/i.test(pathname) == 'movie'? '$&': '$1'), s => s.replace(/\D+/g, '') ] },
  'themoviedb': { name: '.title > span > *:not(.release_date)', year: '.title .release_date', img: 'img.poster' },
  'trakt': { name: '.mobile-title', year: '.mobile-title .year', img: '.poster img.real[alt="poster" i]', alt: [ s => s.replace(/(.+)(\d{4}).*?$/, '$1').replace(/\s*\:\s*Season.*$/i, ''), s => (R.$2 || s) ] },
  'thetvdb': { name: '#series_title', year: 'null', img: 'img[src*="/posters/"]' },
  'tvmaze': { name: 'header.columns > h1', year: '#year', img: 'figure img', alt: [ s => s, s => s.replace(/\((\d+).+\)/, '$1') ] },
  'verizon': { name: (!!~pathname.indexOf('/ondemand/')? decodeURL(pathname.replace(/.+\/tvshows?\/([^\/]+?)\/.*/)): '.detail *, .copy > .title'), year: '.rating *, #showDetails > * > *:nth-child(4) *:last-child, ' + (/\bmovies?\b/.test(pathname)? '.copy > .details': '.summary ~ .title ~ *'), img: '.cover img', plain: true },
  'vrv': { name: '[class^="series"] .title, .series', year: '.additional-information-item', img: '.poster-wrapper img', alt: [ s => s.replace(/(unrated|mature|tv-?\d{1,2})\s*$/i, ''), s => s.replace(/.+(\d{4}).*/, '$1') ] },
  'vudu': { name: '.head-big', year: '.container .row:first-child .row ~ * > .row span', img: 'img[src*="poster"]', alt: [ s => s.replace(/\((\d{4})\)/, ''), s => console.log(typeof s) || s? s.split(/\s*\|\s*/).reverse()[0]: R.$1 ] },
}[host.replace(/(?:[\w\.]+?\.)?(\w+)\.\w+$/, '$1').toLowerCase()]);

let HANDLE = {
  drag: event => {
    event.preventDefault(true);

    event.dataTransfer.dropEffect = 'copy';
  },
  drop: event => {
    event.preventDefault(true);

    let url = event.dataTransfer.getData('text/plain'),
        table = document.querySelector('#wtp--plex-it-plugin'),
        host = (new URL(url)).hostname,
        data = GRAB(host) || {},
        name = (data.plain)? data.name: document.querySelector(data.name) || document.title,
        year = document.querySelector(data.year) || (new Date).getFullYear(),
        img  = document.querySelector(data.img),
        ele  = e => e instanceof Element;

    if(img == 'none')
      img = data.img || '//ephellon.github.io/nunya/plex.filler.png';
    else if(ele(img) && img.tagName != 'IMG')
      img = getComputedStyle(img).backgroundImage;
    else if(ele(img))
      img = img.src;
    else
      img = data.img;

    if(data.child)
      name = name.childNodes[0];

    if(data.alt)
      name = data.alt[0](data.plain || !ele(name)? name: name.textContent),
      year = data.alt[1](ele(year)? year.textContent: year + '');

    name = name.trim();
    year = year.trim();

    if(data.zlt)
      name = data.zlt[0](name),
      year = data.zlt[1](year);

    BookMark(name, url, img);

    table.innerHTML +=
    `<td id="local-${ name }" title="${ (name == document.title)? 'Visit': 'Watch' } &quot;${ name } (${ year })&quot;">
        <a href="${ url }" target="_blank">
            <img src="${ img }" alt="${ name } (${ year })" />
            <label>${ name }</label>
        </a>
    </td>`;
  }
};

</script>
</body>
</html>
